<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="1 Elastic Stack1. 概述 ElasticStack 相比传统大数据分析工具的优势:   使用门槛低, 开发周期短, 上线块  性能好, 查询快, 实时展示结果  扩容方便, 快速制成增长迅速的数据  ElasticStack 包含的内容(ELK+Beats):  Kibaba   可视化工具, 负责数据探索与可视化分析   ElasticSearch   搜索引擎, 负责数据存储,">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticStack">
<meta property="og:url" content="https://destinywang.github.io/blog/2021/04/07/ElasticStack/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 Elastic Stack1. 概述 ElasticStack 相比传统大数据分析工具的优势:   使用门槛低, 开发周期短, 上线块  性能好, 查询快, 实时展示结果  扩容方便, 快速制成增长迅速的数据  ElasticStack 包含的内容(ELK+Beats):  Kibaba   可视化工具, 负责数据探索与可视化分析   ElasticSearch   搜索引擎, 负责数据存储,">
<meta property="og:locale">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gou3s0jyzcj31hi0jwgsl.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gpc26ysl2aj30r80w6jto.jpg">
<meta property="article:published_time" content="2021-04-07T15:35:48.000Z">
<meta property="article:modified_time" content="2021-04-09T10:13:04.293Z">
<meta property="article:author" content="destiny">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gou3s0jyzcj31hi0jwgsl.jpg">



  <link rel="alternate" href="/blog/atom.xml" title="Hexo" type="application/atom+xml" />




  <link rel="canonical" href="https://destinywang.github.io/blog/2021/04/07/ElasticStack/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ElasticStack | Hexo</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a target="_blank" rel="noopener" href="https://github.com/destinywang"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/blog/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />首页</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/blog/archives" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />归档</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-categories">
    <a href="/blog/categories" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />分类</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-tags">
    <a href="/blog/tags" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />标签</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-about">
    <a href="/blog/about" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />关于</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-search">
    <a href="/blog/search" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />搜索</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-commonweal">
    <a href="/blog/404.html" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />公益 404</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-something">
    <a href="/blog/something" rel="section">
      <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />something</a>
</li>

      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://destinywang.github.io/blog/blog/2021/04/07/ElasticStack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ElasticStack</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-07T23:35:48+08:00">2021-04-07</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-Elastic-Stack"><a href="#1-Elastic-Stack" class="headerlink" title="1 Elastic Stack"></a>1 Elastic Stack</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p> ElasticStack 相比传统大数据分析工具的优势:</p>
<ol>
<li> 使用门槛低, 开发周期短, 上线块</li>
<li> 性能好, 查询快, 实时展示结果</li>
<li> 扩容方便, 快速制成增长迅速的数据</li>
</ol>
<p>ElasticStack 包含的内容(ELK+Beats):</p>
<ul>
<li>Kibaba<ul>
<li>  可视化工具, 负责数据探索与可视化分析</li>
</ul>
</li>
<li>ElasticSearch<ul>
<li>  搜索引擎, 负责数据存储, 查询和分析</li>
</ul>
</li>
<li>Logstash + Beats: 负责数据的收集和处理<ul>
<li>  ETL: Extract Transform Load</li>
<li>支持多种数据源<ul>
<li>  数据文件, 如日志, Excel</li>
<li>  数据库, 如 MySQL, Oracle</li>
<li>  Http 服务</li>
<li>  网络数据</li>
</ul>
</li>
<li>  支持自定义扩展</li>
</ul>
</li>
</ul>
<p>ElasticStack 常见用途:</p>
<ol>
<li> 搜索引擎</li>
<li> 日志分析</li>
<li> 指标分析</li>
</ol>
<h2 id="1-2-安装"><a href="#1-2-安装" class="headerlink" title="1.2 安装"></a>1.2 安装</h2><h3 id="1-2-1-Elasticsearch"><a href="#1-2-1-Elasticsearch" class="headerlink" title="1.2.1 Elasticsearch"></a>1.2.1 Elasticsearch</h3><h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><p>从  <code>dockerhub</code> 上安装镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull elasticsearch:7.11.1</span><br></pre></td></tr></table></figure>

<p>编写 docker 启动 Elasticsearch 脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line">docker stop elasticsearch</span><br><span class="line">docker rm elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> $(PWD)</span><br><span class="line"></span><br><span class="line">docker run -d -p 9200:9200 -p 9300:9300 -e ES_JAVA_OPTS=<span class="string">&quot;-Xms1024m -Xmx1024m&quot;</span> -e <span class="string">&quot;discovery.type=single-node&quot;</span> -v $(PWD)/data:/usr/share/elasticsearch/data -v $(PWD)/<span class="built_in">log</span>:/usr/share/elasticsearch/logs --name elasticsearch elasticsearch:7.11.1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;elasticsearch start success&#x27;</span></span><br></pre></td></tr></table></figure>

<p>其中需要注意:</p>
<ul>
<li><p>   <code>discovery.type=single-node</code> 用来指定以单节点模式启动</p>
</li>
<li><p>数据挂载路径 <code>usr/share/elasticsearch/data</code> 和日志挂载路径  <code>usr/share/elasticsearch/logs</code> ,  是根据 <code>docker inspect elasticsearch:7.11.1</code> 中的 <code>WorkingDir&quot;: &quot;/usr/share/elasticsearch</code> 确定</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">	<span class="attr">&quot;WorkingDir&quot;</span>: <span class="string">&quot;/usr/share/elasticsearch&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Entrypoint&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;/bin/tini&quot;</span>,</span><br><span class="line">    <span class="string">&quot;--&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/local/bin/docker-entrypoint.sh&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  再根据Entrypoint 确定启动脚本中的内容</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="subst">$(id -u)</span>&quot;</span> == <span class="string">&quot;0&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="comment"># If requested and running as root, mutate the ownership of bind-mounts</span></span><br><span class="line">  <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$TAKE_FILE_OWNERSHIP</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    chown -R 1000:0 /usr/share/elasticsearch/&#123;data,logs&#125;</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-2-2-LogStash"><a href="#1-2-2-LogStash" class="headerlink" title="1.2.2 LogStash"></a>1.2.2 LogStash</h3><h3 id="1-2-3-Beats"><a href="#1-2-3-Beats" class="headerlink" title="1.2.3 Beats"></a>1.2.3 Beats</h3><h3 id="1-2-4-Kinbana"><a href="#1-2-4-Kinbana" class="headerlink" title="1.2.4 Kinbana"></a>1.2.4 Kinbana</h3><h1 id="2-Elasticsearch"><a href="#2-Elasticsearch" class="headerlink" title="2. Elasticsearch"></a>2. Elasticsearch</h1><h2 id="2-1-概述"><a href="#2-1-概述" class="headerlink" title="2.1 概述"></a>2.1 概述</h2><h3 id="2-1-1-常见术语"><a href="#2-1-1-常见术语" class="headerlink" title="2.1.1 常见术语"></a>2.1.1 常见术语</h3><table>
<thead>
<tr>
<th>ES 中的概念</th>
<th>描述</th>
<th>类比</th>
</tr>
</thead>
<tbody><tr>
<td>文档 Document</td>
<td>用户存储在 es 中的数据文档</td>
<td>类似 MySQL 中的记录</td>
</tr>
<tr>
<td>索引 Index</td>
<td>由具有相同字段的文档列表组成</td>
<td>类似 MySQL 中的 table</td>
</tr>
<tr>
<td>映射 Mapping</td>
<td>定义索引包含的字段名和类型等元信息</td>
<td>类似 MySQL 的 schema</td>
</tr>
<tr>
<td>节点 Node</td>
<td>一个 Elasticsearch 的运行实例, 是集群的构成单元</td>
<td></td>
</tr>
<tr>
<td>集群 Cluster</td>
<td>由一个或多个节点组成, 对外提供服务</td>
<td></td>
</tr>
</tbody></table>
<h4 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h4><p>类型: JsonObject, 由字段(Field)组成, 常见数据类型如下:</p>
<ul>
<li>  字符串: text, keyword</li>
<li>  数值型: long, integer, short, byte, double, float, half_float, scaled_float</li>
<li>  布尔: boolean</li>
<li>  日期: date</li>
<li>  二进制: binary</li>
<li>  范围类型: integer_range, float_range, long_range, double_range, date_range</li>
</ul>
<p>每个文档都有唯一的 id 标识</p>
<ul>
<li><p>  自行指定</p>
</li>
<li><p>  es 自动生成</p>
</li>
</ul>
<p>元数据, 用于标注文档的相关信息</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td><code>_index</code></td>
<td>文档所在的索引名</td>
</tr>
<tr>
<td><code>_type</code></td>
<td>文档所在的类型名(即将废弃)</td>
</tr>
<tr>
<td><code>_id</code></td>
<td>文档唯一 id</td>
</tr>
<tr>
<td><code>_uid</code></td>
<td>组合 id, 由 <code>_type</code> 和 <code>_id</code> 组成(未来 type 废弃后会和 id 相同)</td>
</tr>
<tr>
<td><code>_source</code></td>
<td>文档的原始 json 数据, 可以从这里获取每个字段的内容</td>
</tr>
<tr>
<td><code>_all</code></td>
<td>整合所有字段内容到该字段(比较占空间且查询效率不高, 6.0 已经默认禁用)</td>
</tr>
</tbody></table>
<h4 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h4><p>索引中存储具有相同结构的文档, 每个文档都有自己的 <code>mapping</code> 定义, 用于定义字段名和类型等元信息</p>
<p>一个集群可以有多个索引</p>
<h3 id="2-1-2-RESTAPI"><a href="#2-1-2-RESTAPI" class="headerlink" title="2.1.2 RESTAPI"></a>2.1.2 RESTAPI</h3><p>Elasticsearch 集群对外提供 RESTful API:</p>
<ul>
<li>  REST: REpresentational State Transfer(表现层状态转移, 表现层指资源)</li>
<li>  URI 指定资源, 如 Index, Document 等</li>
<li>  Http Method 指明资源操作类型, 如 Get, Post, Put, Delete 等</li>
</ul>
<p>常见交互方式:</p>
<ul>
<li>  Curl 命令行</li>
<li>  Kibana DevTools</li>
</ul>
<h3 id="2-1-3-索引-API"><a href="#2-1-3-索引-API" class="headerlink" title="2.1.3 索引 API"></a>2.1.3 索引 API</h3><p>es 有专门的 IndexAPI, 用于创建, 更新, 删除索引配置等</p>
<ul>
<li><p>创建索引 api 如下</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index</span><br><span class="line"></span><br><span class="line">resp:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;shards_acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;test_index&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>查看现有索引</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_cat&#x2F;indices</span><br><span class="line"></span><br><span class="line">green  open .apm-custom-link                RkPmPmV0TTiqjDY1BcuZHg 1 0    0    0    208b    208b</span><br><span class="line">green  open kibana_sample_data_ecommerce    UVvkmSlpRv6oGuXDQwmtiA 1 0 4675    0     4mb     4mb</span><br><span class="line">green  open .kibana-event-log-7.11.1-000001 hY3-zLbTSJurWBhAUxRs-g 1 0    4    0  21.8kb  21.8kb</span><br><span class="line">green  open .kibana_task_manager_1          CV0RqH_eTf6Z6UN4EJkG1Q 1 0    8 1288 247.1kb 247.1kb</span><br><span class="line">green  open .apm-agent-configuration        c5zj1ZBgRduWHKhbNo8kgw 1 0    0    0    208b    208b</span><br><span class="line">green  open .async-search                   tgGPCSDGTKWYppN0_aHO6w 1 0    0    0   5.6kb   5.6kb</span><br><span class="line">yellow open test_index                      8BG1bULAS-2D2HiEqkIdWw 1 1    0    0    208b    208b</span><br><span class="line">green  open .kibana_1                       inVHSYXITsKGc0TFas8wcQ 1 0  117   54     3mb     3mb</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-1-4-文档-API"><a href="#2-1-4-文档-API" class="headerlink" title="2.1.4 文档 API"></a>2.1.4 文档 API</h3><h4 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h4><ul>
<li><p>创建文档时, 如果索引不存在, es 会自动创建对应的 index 和 type</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/1			// PUT 代表新增, test_index 代表 index, doc 代表 type, 1 代表 id</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;age&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>不指定 id 创建文档 api, 返回的 id 是 es 自动生成的</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;tom&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;age&quot;</span>: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;3dapWHgBNjqeYmKhg89n&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="批量创建文档"><a href="#批量创建文档" class="headerlink" title="批量创建文档"></a>批量创建文档</h4><ul>
<li><p>  es 允许一次创建多个文档, 从而减少网络传输开销, 提升写入速率, endpoint 为 <code>_bulk</code></p>
</li>
<li><p>bulk 的每一个操作都需要两个 json 串, 语法如下:</p>
<ul>
<li>  <code>&#123;&quot;action&quot;: &#123;&quot;metadata&quot;&#125;&#125;</code></li>
<li>  <code>&#123;&quot;data&quot;&#125;</code></li>
</ul>
</li>
<li><p>可执行的操作</p>
<ul>
<li>  delete: 删除一个文档, 只需要一个 json 串</li>
<li>  create: 执行 <code>PUT /index/id/_create</code>, 强制创建</li>
<li>  index: 普通的 put 操作, 可以创建/替换文档</li>
<li>  update: 执行 partial update 操作</li>
</ul>
</li>
<li><p>  bulk api对json的语法，有严格的要求，每个json串不能换行，只能放一行，同时一个json串和一个json串之间，必须有一个换行</p>
</li>
<li><p>bulk操作中，任意一个操作失败，是不会影响其他的操作的，但是在返回结果里，会告诉你异常日志</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;test_index&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>,<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;3&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;username&quot;</span>:<span class="string">&quot;alfred&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">10</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;delete&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;test_index&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;doc&quot;</span>,<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">14</span>,</span><br><span class="line">  <span class="attr">&quot;errors&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;items&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;index&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">3</span>,</span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span> : <span class="number">201</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;delete&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;deleted&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">4</span>,</span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span> : <span class="number">200</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h4><ul>
<li><p>指定要查询的文档 id, <code>_source</code> 存储了文档的完整原始信息</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_doc/1</span><br><span class="line"></span><br><span class="line">resp:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span> : <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>如果 id 不存在, 会返回 404</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_doc/3</span><br><span class="line"></span><br><span class="line">resp:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> : <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>搜索所有文档, 需要使用 <code>_search</code></p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,												<span class="comment">// 查询耗时, 单位 ms</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">1</span>,									<span class="comment">// 符合条件的总文档数</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [											<span class="comment">// 返回文档的详情数组, 默认返回前 10 个</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,							<span class="comment">// 文档的得分</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="批量查询文档"><a href="#批量查询文档" class="headerlink" title="批量查询文档"></a>批量查询文档</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> : <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">7</span>,</span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;destiny&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;age&quot;</span> : <span class="string">&quot;20&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> : <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_index&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">7</span>,</span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;destiny&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;age&quot;</span> : <span class="string">&quot;20&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h4><h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><h2 id="2-2-倒排索引与分词"><a href="#2-2-倒排索引与分词" class="headerlink" title="2.2 倒排索引与分词"></a>2.2 倒排索引与分词</h2><h3 id="2-2-1-简介"><a href="#2-2-1-简介" class="headerlink" title="2.2.1 简介"></a>2.2.1 简介</h3><ul>
<li><p>正排索引: 对应书的目录页, 文档 id 到文档内容, 单词的关联关系</p>
<table>
<thead>
<tr>
<th>文档 id</th>
<th>文档内容</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Elasticsearch is a search engine</td>
</tr>
<tr>
<td>2</td>
<td>Google is a Search Engine</td>
</tr>
<tr>
<td>3</td>
<td>Search engine is important for applications</td>
</tr>
</tbody></table>
</li>
<li><p>倒排索引: 对应书的索引页, 单词到文档 id 的关联关系</p>
<table>
<thead>
<tr>
<th>单词</th>
<th>文档 id 列表</th>
</tr>
</thead>
<tbody><tr>
<td>Elasticsearch</td>
<td>1</td>
</tr>
<tr>
<td>is</td>
<td>1, 2, 3</td>
</tr>
<tr>
<td>a</td>
<td>1, 2</td>
</tr>
<tr>
<td>search</td>
<td>1, 2, 3</td>
</tr>
<tr>
<td>engine</td>
<td>1, 2, 3</td>
</tr>
<tr>
<td>google</td>
<td>2</td>
</tr>
<tr>
<td>important</td>
<td>3</td>
</tr>
<tr>
<td>for</td>
<td>3</td>
</tr>
<tr>
<td>applications</td>
<td>3</td>
</tr>
</tbody></table>
</li>
</ul>
<p>倒排索引查询流程:</p>
<ul>
<li>查询包含 SearchEngine 的文档<ul>
<li>  通过倒排索引获取 <code>SearchEngine</code> 对应的文档: 1, 2, 3</li>
<li>  通过正排索引查询 1, 2, 3 的完整内容</li>
<li>  返回用户最终结果</li>
</ul>
</li>
</ul>
<h3 id="2-2-2-倒排索引的组成"><a href="#2-2-2-倒排索引的组成" class="headerlink" title="2.2.2 倒排索引的组成"></a>2.2.2 倒排索引的组成</h3><p>倒排索引是搜索引擎的核心, 主要包含两部分:</p>
<ul>
<li><p>单词词典(Term Dictionary)</p>
<ul>
<li>  记录所有文档的单词, 一般都比较大</li>
<li>  记录单词到倒排列表的相关信息</li>
<li>单词字典的实现一般采用 B+Tree  <img src="https://tva1.sinaimg.cn/large/008eGmZEly1gou3s0jyzcj31hi0jwgsl.jpg" style="zoom:70%;" /></li>
</ul>
</li>
<li><p>倒排列表(Posting List), 记录了单词对应的文档集合, 由倒排索引项组成, 倒排索引项的组成如下:</p>
<blockquote>
<p>  以  <code>search</code> 为例:</p>
<table>
<thead>
<tr>
<th>DocId</th>
<th>TF</th>
<th>Position</th>
<th>Offset</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>&lt;18, 24&gt;</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>1</td>
<td>&lt;11, 17&gt;</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>0</td>
<td>&lt;0, 6&gt;</td>
</tr>
</tbody></table>
</blockquote>
<ul>
<li>  文档 id, 用于获取原始信息</li>
<li>  单词频率, 记录该单词在对应文档中的出现次数, 用于后续相关性计算</li>
<li>  位置: 记录单词在文档中的分词位置(多个), 用于做词语搜索</li>
<li>  偏移, 记录单词在文档的开始和结束位置, 用于做高亮展示</li>
</ul>
</li>
<li><p>  单词字典和倒排索引整合在一起的结构为: 单词字典的 B+树每一个叶子节点都指向倒排列表的下标</p>
</li>
<li><p>es 存储的是一个 json 格式的文档, 每个字段都会有自己的倒排索引, 如</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;job&quot;</span>: <span class="string">&quot;programmer&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">此时 username 和 job 分别会创建对应的倒排索引</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-2-3-分词"><a href="#2-2-3-分词" class="headerlink" title="2.2.3 分词"></a>2.2.3 分词</h3><p>分词是指将文本转换成一系列单词的过程, 也可以叫做文本分析, 在 es 中被称为 <code>Analysis</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;Elasticsearch 是最流程的搜索引擎&quot; &#x3D;&gt; [&quot;Elasticsearch&quot;, &quot;流行&quot;, &quot;搜索引擎&quot; ]</span><br></pre></td></tr></table></figure>

<p>分词器是 es 中专门处理分词的组件, 英文为 Analyzer, 它的组成如下:</p>
<ul>
<li>  Character Filters: 针对原始文本进行处理, 比如去除 html 特殊标记</li>
<li>  Tokenizer: 将原始文本按照一定规则切分为单词</li>
<li>  Token Filters: 针对 <code>Tokenizer</code> 处理的单词进行再加工, 比如转小写, 删除或新增等处理</li>
</ul>
<h4 id="Analyze-API"><a href="#Analyze-API" class="headerlink" title="Analyze API"></a>Analyze API</h4><ul>
<li><p>直接指定 analyzer 进行测试:</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze </span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;Im van, Im an artist&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;im&quot;</span>,					<span class="comment">// 分词结果</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">0</span>,			<span class="comment">// 起始偏移</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">2</span>,				<span class="comment">// 结束偏移</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">0</span>					<span class="comment">// 分词位置</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;van&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">6</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;im&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">8</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;an&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">11</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">13</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;artist&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">14</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">20</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>直接指定索引中的字段进行测试(调试时使用, 查看该字段实际的分词方式):</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">POST test_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;username&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;Im van, Im an artist&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;im&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;van&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">6</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;im&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">8</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;an&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">11</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">13</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;artist&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">14</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">20</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>自定义分词器进行测试(按照自己的需求定制分词器, 主要用于调试自己实际需要的分词器):</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokenizer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;filter&quot;</span>: [<span class="string">&quot;lowercase&quot;</span>],				<span class="comment">// token filter</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;Im van, Im an artist&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;im&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;van&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">6</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;im&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">8</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;an&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">11</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">13</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;artist&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">14</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">20</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="预定义的分词器"><a href="#预定义的分词器" class="headerlink" title="预定义的分词器"></a>预定义的分词器</h4><ul>
<li>Standard Analyzer:<ul>
<li>默认分词器, 组成如下:<ul>
<li>  Tokenizer: <code>standard</code></li>
<li>  TokenFilters: [<code>standard</code>, <code>Lower case</code>, <code>Stop(默认不开启)</code>]</li>
</ul>
</li>
<li>  按词切分, 支持多语言</li>
<li>  小写处理</li>
</ul>
</li>
<li>Simple Analyzer:<ul>
<li>组成:<ul>
<li>  Tokenizer: <code>Lower Case</code></li>
</ul>
</li>
<li>  按照非字母切分</li>
<li>  小写处理</li>
</ul>
</li>
<li>Whitespace Analyzer<ul>
<li>组成:<ul>
<li>  Tokenizer: <code>Whitespace</code></li>
</ul>
</li>
<li>  仅按照空格切分</li>
</ul>
</li>
<li>Stop Analyzer(Stop Word: 指语气助词等修饰性词语):<ul>
<li>组成:<ul>
<li>  Tokenizer: <code>LowerCase</code></li>
<li>  Token Filters: [<code>Stop</code>]</li>
</ul>
</li>
</ul>
</li>
<li>Keyword Analyzer<ul>
<li>组成:<ul>
<li>  Tokenizer: <code>keyword</code></li>
</ul>
</li>
<li>  不分词, 直接将输入作为一个单词输出</li>
</ul>
</li>
<li>Pattern Analyzer<ul>
<li>组成:<ul>
<li>  Tokenizer: Pattern</li>
<li>  Token Filters: [<code>Lower case</code>, <code>Stop(默认不开启)</code>]</li>
</ul>
</li>
<li>  通过正则表达式自定义分隔符, 默认为 <code>\W+</code>, 即非字符的符号作为分隔符</li>
</ul>
</li>
<li>Language Analyzer<ul>
<li>  提供了 30+常见语言的分词器</li>
</ul>
</li>
</ul>
<h4 id="中文分词"><a href="#中文分词" class="headerlink" title="中文分词"></a>中文分词</h4><p>受限于中文语境, 难度较大</p>
<p>常见分词系统:</p>
<ul>
<li>IK<ul>
<li>  实现中英文单词的切分, 支持 ik_smart, ik_maxword 等模式</li>
<li>  可以自定义词库, 支持热更新分词词典</li>
<li>  <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></li>
</ul>
</li>
<li>jieba<ul>
<li>  python 中最流行的分词系统, 支持分词和词性标注</li>
<li>  支持繁体分词, 自定义词典, 并行分词等</li>
<li>  <a target="_blank" rel="noopener" href="https://github.com/sing1ee/elasticsearch-jieba-plugin">https://github.com/sing1ee/elasticsearch-jieba-plugin</a></li>
</ul>
</li>
</ul>
<p>基于自然语言处理的分词系统:</p>
<ul>
<li>Hanlp<ul>
<li>  由一系列模型与算法组成的 java 工具包, 目标是普及自然语言处理在生产环境中的应用</li>
<li>  <a target="_blank" rel="noopener" href="https://github.com/hankcs/HanLP">https://github.com/hankcs/HanLP</a></li>
</ul>
</li>
<li>THULAC<ul>
<li>  THU Lexical Analyzer for Chinese, 由清华大学自然语言处理与人文社会计算实验室研制推出的一套中文词法分析工具包, 具有中文分词和词性标注功能</li>
<li>  <a target="_blank" rel="noopener" href="https://github.com/microbun/elasticsearch-thulac-plugin">https://github.com/microbun/elasticsearch-thulac-plugin</a></li>
</ul>
</li>
</ul>
<h4 id="自定义分词"><a href="#自定义分词" class="headerlink" title="自定义分词"></a>自定义分词</h4><p>通过自定义 Character Filters, Tokenizer 和 Token Filter 实现:</p>
<ul>
<li>CharacterFilters:<ul>
<li>  在 Tokenizer 之前对原始文本进行处理, 比如增加, 删除或替换字符等</li>
<li>自带功能如下:<ul>
<li>  HTML Strip 去除 html 标签和转换 html 实体</li>
<li>  Mapping 进行字符串替换操作</li>
<li>  Pattern Replace 进行正则匹配替换</li>
</ul>
</li>
<li>  会影响后续 Tokenizer 解析的 postion 和 offset 信息</li>
</ul>
</li>
</ul>
<h2 id="2-3-Mapping"><a href="#2-3-Mapping" class="headerlink" title="2.3 Mapping"></a>2.3 Mapping</h2><h3 id="2-3-1-简介"><a href="#2-3-1-简介" class="headerlink" title="2.3.1 简介"></a>2.3.1 简介</h3><p>类似数据库中的表结构定义, 主要作用如下:</p>
<ul>
<li>  定义 index 下的字段名</li>
<li>  定义字段类型</li>
<li>  定义倒排索引相关的配置, 比如是否索引, 是否记录 position 等</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test_index&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;age&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;long&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;username&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2-自定义-mapping"><a href="#2-3-2-自定义-mapping" class="headerlink" title="2.3.2 自定义 mapping"></a>2.3.2 自定义 mapping</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;shards_acknowledged&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;my_index&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Mapping 中的字段类型一旦设定成功后, 禁止直接修改, 因为 Lucene 实现的倒排索引生成后不允许修改, 需要重新建立新的索引, 然后做 <code>reindex</code> 操作</p>
<ul>
<li><p><code>dynamic</code></p>
<ul>
<li>可以通过 <code>dynamic</code> 参数来控制字段的新增:<ul>
<li>  true(默认): 允许自动新增字段</li>
<li>  false: 不允许自动新增字段, 但是文档可以正常写入, 但无法对字段进行查询等操作</li>
<li>  strict: 文档不能写入, 直接报错</li>
</ul>
</li>
<li>  <code>dynamic</code> 字段可以给设置到 index 级别, 或者可以设置到 object 级别</li>
</ul>
</li>
<li><p><code>copy_to</code></p>
<ul>
<li>  将该字段的值复制到目标字段, 实现类似 <code>_all</code> 的作用</li>
<li>  不会出现在 <code>_source</code> 中, 只用来搜索</li>
</ul>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;first_name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span>: <span class="string">&quot;full_name&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;last_name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span>: <span class="string">&quot;full_name&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写值</span></span><br><span class="line">PUT my_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;first_name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;last_name&quot;</span>: <span class="string">&quot;Smith&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索</span></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;John Smith&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>index</code></p>
<ul>
<li>  控制当前字段是否生成搜索, 默认为 true, 即记录索引, false 为不记录, 即不可搜索</li>
</ul>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cookie&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span>		<span class="comment">// 此时cookie 字段不会生成索引, 因此查询时会报错</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>index_options</code>: 用于控制记录倒排索引的内容</p>
<ul>
<li>取值如下:<ul>
<li>  docs: 只记录 docId</li>
<li>  freqs: 记录 docId 和 termFrequencies</li>
<li>  positions: 记录 docId, termFrequencies 和 termPosition</li>
<li>  offset: 记录 docId, termFrequencies 和 termPosition 和 characterOffset</li>
</ul>
</li>
<li>  text 类型默认配置为 <code>position</code>, 其他默认为 docs</li>
<li>  记录内容越多, 占用空间越大</li>
</ul>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cookie&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index_options&quot;</span>: <span class="string">&quot;offsets&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>null_value</code>: 指明 es 对 null 值得处理策略, 默认为 null, 即空值, 此时 es 会忽略该值, 可以通过设定该值设定字段的默认值</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cookie&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;null_value&quot;</span>: <span class="string">&quot;NULL&quot;</span>		<span class="comment">// 标明该字段如果传 null 时默认值为 &quot;NULL&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-3-3-核心数据类型"><a href="#2-3-3-核心数据类型" class="headerlink" title="2.3.3 核心数据类型"></a>2.3.3 核心数据类型</h3><p>核心数据类型:</p>
<ul>
<li>  字符串型: text(分词), keyword(不分词)</li>
<li>  数值型: long, integer, short, byte, double, float, half_float, scaled_float</li>
<li>  日期类型: date</li>
<li>  布尔类型: boolean</li>
<li>  二进制类型: binary</li>
<li>  范围类型: integer_range, float_range, long_range, double_range, date_range</li>
</ul>
<p>负责数据类型:</p>
<ul>
<li>  数组类型: array(由于倒排索引的特性, es 所有数据类型天生支持索引)</li>
<li>  对象类型: object</li>
<li>  嵌套类型: nested object(独立存在, 没有和父文档混在一起)</li>
</ul>
<p>地理位置数据类型:</p>
<ul>
<li>  geo_point</li>
<li>  geo_shape</li>
</ul>
<p>专用类型:</p>
<ul>
<li>  ip: 记录 pi 地址</li>
<li>  completion: 实现自动补全</li>
<li>  token_count: 记录分词数</li>
<li>  murmur3: 记录字符串 hash 值</li>
<li>  percolator</li>
<li>  join</li>
</ul>
<p>多字段特性(<code>multi_fields</code>): 允许对同一字段采用不同配置, 比如分词, 常见例子如对人名实现拼音搜索, 只需要在人名中新增一个子字段 <code>pinyin</code> 即可</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test_index&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;username&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;pinyin&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;pinyin&quot;</span>	<span class="comment">// </span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-4-Dynamic-Mapping"><a href="#2-3-4-Dynamic-Mapping" class="headerlink" title="2.3.4 Dynamic Mapping"></a>2.3.4 Dynamic Mapping</h3><p>es 可以自动识别文档字段类型, 从而降低用户使用成本</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /test_index/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test_index&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;age&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;long&quot;</span>		<span class="comment">// 自动识别 age 为 long 类型</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;username&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,	<span class="comment">// 自动识别 username 为 text</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>es 是依靠 json 文档的字段类型来实现自动识别字段类型, 支持的字段类型如下:</p>
<table>
<thead>
<tr>
<th>JSON 类型</th>
<th>es 映射类型</th>
</tr>
</thead>
<tbody><tr>
<td>null</td>
<td>忽略(如果 es 设置 <code>null_value</code>, 会将 null 值映射为预设的值并推断相应类型)</td>
</tr>
<tr>
<td>boolean</td>
<td>boolean</td>
</tr>
<tr>
<td>浮点</td>
<td>float</td>
</tr>
<tr>
<td>整型</td>
<td>long</td>
</tr>
<tr>
<td>object</td>
<td>object</td>
</tr>
<tr>
<td>array</td>
<td>由第一个非 null 值得类型决定</td>
</tr>
<tr>
<td>string</td>
<td>匹配为日期则设为 date 类型(默认开启)<br />匹配为数字的话设为 float 或 long 类型(默认关闭)<br />设为 text 类型, 并附带 keyword 的子字段</td>
</tr>
</tbody></table>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;age&quot;</span>: <span class="number">14</span>,</span><br><span class="line">  <span class="attr">&quot;birth&quot;</span>: <span class="string">&quot;1994-03-31&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;married&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;year&quot;</span>: <span class="string">&quot;18&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;deep&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dark&quot;</span>,</span><br><span class="line">    <span class="string">&quot;fantasy&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;score&quot;</span>: <span class="number">76.5</span>  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /test_index/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;test_index&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;age&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;long&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;birth&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;married&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;boolean&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;score&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;tags&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;username&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;year&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-5-日期与数字的识别"><a href="#2-3-5-日期与数字的识别" class="headerlink" title="2.3.5 日期与数字的识别"></a>2.3.5 日期与数字的识别</h3><ul>
<li>日期的自动识别可以可以自行配置日期格式, 以满足各种需求<br>  默认是 <code>[&quot;strict_date_optional_time&quot;, &quot;yyyy/MM/dd HH:mm:ss Z || yyyy/MM/dd Z&quot;]</code></li>
<li>strict_date_optional_time 是 ISO datetime, 完整格式类似:<br>  <code>YYYY-MM-DDThh:mm:ssTZD(e.g. 2021-03-29T20:24:05 +08:00)</code></li>
<li>  dynamic_date_formats 可以自动以日期类型</li>
<li>  date_detection 可以关闭日期自动识别机制</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义日期识别格式</span></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;dynamic_date_formats&quot;</span>: [<span class="string">&quot;MM/dd/yyyy&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭日期自动识别机制</span></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;date_detection&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-6-DynamicTemplates"><a href="#2-3-6-DynamicTemplates" class="headerlink" title="2.3.6 DynamicTemplates"></a>2.3.6 DynamicTemplates</h3><ul>
<li>  执行顺序默认由上到下执行, 创建索引时会以此比较所有 <code>dynamic_template</code></li>
<li>允许根据 es 自动识别的数据类型, 字段名来动态设定字段类型, 可实现如下效果:<ul>
<li>  将所有字符串类型都设定为 keyword 类型, 即默认不分词</li>
<li>  所有以 message 开头的字段都设定为 text 字段</li>
<li>  所有以 long_开头的字段都设定为 long 类型</li>
<li>  所有识别为 double 类型的字段都设定为 float</li>
</ul>
</li>
<li>建议:<ul>
<li>  写入一条文档到 es 的临时索引中, 获取 es 自动生成的 mapping</li>
<li>  修改步骤一得到的 mapping, 自定义相关配置</li>
<li>  使用步骤二的 mapping 创建实际索引</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;doc&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;dynamic_templates&quot;</span>: [									<span class="comment">// 数组, 可指定多个匹配规则</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;string_as_keywords&quot;</span>: &#123;							<span class="comment">// template 名称</span></span><br><span class="line">            <span class="attr">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>,		<span class="comment">// 规则</span></span><br><span class="line">            <span class="attr">&quot;match&quot;</span>: <span class="string">&quot;msg_*&quot;</span>,									<span class="comment">// 以 msg_ 开头的字段都设置为 text 类型</span></span><br><span class="line">            <span class="attr">&quot;mapping&quot;</span>: &#123;											<span class="comment">// 实际需要的 mapping 信息</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>关键词</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td><code>match_mapping_type</code></td>
<td>匹配 es 自动识别的字段类型, 如 boolean, long, string 等</td>
</tr>
<tr>
<td><code>match / unmatch</code></td>
<td>匹配字段名</td>
</tr>
<tr>
<td><code>path_match / path_unmatch</code></td>
<td>匹配路径(对象内部的字段)</td>
</tr>
</tbody></table>
<h3 id="2-3-7-索引模板"><a href="#2-3-7-索引模板" class="headerlink" title="2.3.7 索引模板"></a>2.3.7 索引模板</h3><ul>
<li>IndexTemplate, 主要用于在新建索引时自动应用预先设定的配置, 简化索引创建的操作步骤<ul>
<li>  可以设定索引的配置和 mapping</li>
<li>  可以有多个模板, 根据 order 配置, order 大的覆盖小的配置</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT _template/test_template						// template 名称</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span>: [<span class="string">&quot;te*&quot;</span>, <span class="string">&quot;bar*&quot;</span>],	<span class="comment">// 匹配的索引名称</span></span><br><span class="line">  <span class="attr">&quot;order&quot;</span>: <span class="number">0</span>,													<span class="comment">// 顺序配置</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;												<span class="comment">// 索引的配置</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4-Search-API"><a href="#2-4-Search-API" class="headerlink" title="2.4 Search API"></a>2.4 Search API</h2><ul>
<li><p>搜索方式</p>
<ul>
<li>  match: 查询语句会被分词, 返回包含一个或多个分词结果的文档</li>
<li>  match_phrase: 查询语句会被分词, 返回同时包含所有分词结果的文档</li>
<li>term: 完全匹配, 不进行分词器分析, 文档中必须包含整个查询语句</li>
</ul>
</li>
<li><p>实现对 es 中存储的数据进行查询分析, endpoint 为 <code>_search</code>:</p>
<ul>
<li>  <code>GET /_search</code></li>
<li>  <code>GET /my_index/_search</code></li>
<li>  <code>GET /my_index1,my_index2/_search</code></li>
<li>  <code>GET /my_*/_search</code></li>
</ul>
</li>
<li><p>主要有两种查询形式</p>
<ul>
<li><p>URI search</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search?q=user:alfred</span><br></pre></td></tr></table></figure>

<ul>
<li>  操作简单, 方便通过命令行测试</li>
<li>  仅包含部分查询语法</li>
</ul>
</li>
<li><p>Request Body Search</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;user&quot;</span>: <span class="string">&quot;alfred&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>  es 提供完备的查询语法 Query DSL(Domain Specific Language)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-4-1-URI-Search"><a href="#2-4-1-URI-Search" class="headerlink" title="2.4.1 URI Search"></a>2.4.1 URI Search</h3><p>通过 url query 参数来实现搜索, 常用参数如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search?q=alfred&amp;df=user&amp;sort=age:asc&amp;from=4&amp;size=10&amp;timeout=1s</span><br><span class="line"><span class="comment">// 查询 user 字段包含 alfred 的文档</span></span><br><span class="line"><span class="comment">// 结果按照 age 升序排列</span></span><br><span class="line"><span class="comment">// 返回 5~14 个文档</span></span><br><span class="line"><span class="comment">// 如果超过 1s 没返回则以超时结束</span></span><br></pre></td></tr></table></figure>

<ul>
<li>  q: 指定查询的语句, 语法为 <code>Query String Syntax</code></li>
<li>  df: q 中不指定字段时默认查询的字段, 如果不指定, es 会查询所有的字段</li>
<li>  sort: 排序</li>
<li>  timeout: 指定超时时间, 默认不超时</li>
<li>  from, size: 分页</li>
</ul>
<p>QueryStringSyntax:</p>
<ul>
<li>term 与 phrase:<ul>
<li>  term 标识多个单词: <code>alfred way</code> 等效于 <code>alfred OR way</code></li>
<li>  phrase 标识一个词语(先后顺序): <code>&quot;alfred way&quot;</code> 词语查询, 要求先后顺序</li>
</ul>
</li>
<li>泛查询<ul>
<li>  alfred 等效于在所有字段去匹配该 term</li>
</ul>
</li>
<li>指定字段<ul>
<li>  name:alfred</li>
</ul>
</li>
<li>Group: 分组设定, 使用括号指定匹配的规则<ul>
<li>  (quick OR brown) AND fox</li>
<li>  status:(active OR pending) title:(full text search), 如果不加括号 <code>status:active OR pending</code> 会变成 <code>status 字段为 active 或任意字段包含 pending</code> </li>
</ul>
</li>
<li>布尔操作符<ul>
<li>AND(&amp;&amp;), OR(||), NOT(!)<ul>
<li>  name:(tom NOT lee): name 中包含 tom 但不包含 lee 的所有文档</li>
<li>  必须大写不能小写</li>
</ul>
</li>
<li><code>+ / -</code> 分别对应 must 和 must_not<ul>
<li>  name:(tom +lee -alfred): name 一定包含 lee, 一定不包含 alfred, 可以包含 tom 的文档</li>
<li>  对应的 AND/OR/NOT 写法为: name((lee &amp;&amp; !alfred) || (tom &amp;&amp; lee &amp;&amp; !alfred))</li>
<li>  <code>+</code> 在 url 中会被解析为空格, 要使用 encode 后的结果才可以, 为 <code>%2B</code></li>
</ul>
</li>
</ul>
</li>
<li>范围查询, 支持数值和日期<ul>
<li>区间写法, 闭区间用 <code>[]</code>, 开区间用 <code>&#123;&#125;</code><ul>
<li>  age: [1 TO 10], 意为 1&lt;=age&lt;=10</li>
<li>  age: [1 TO 10}, 意为 1&lt;=age&lt;10</li>
<li>  age: [1 TO ], 意为 1&lt;= age</li>
<li>  age: [* TO 10], 意为 age &lt;= 10</li>
</ul>
</li>
<li>算数符号写法<ul>
<li>  age: &gt;=1</li>
<li>  age:(&gt;=1 &amp;&amp; &lt;= 10) 或者 age:(+&gt;=1+&lt;=10)</li>
</ul>
</li>
</ul>
</li>
<li>通配符查询:<ul>
<li><code>?</code> 代表 1 个字符, <code>*</code> 代表多个字符<ul>
<li>  name:t?m</li>
<li>  name:tom*</li>
<li>  name:t*m</li>
</ul>
</li>
<li>  通配符匹配执行效率低, 且占用较多内存, 不建议使用</li>
<li>  如无特殊要求, 不要将 <code>?/*</code> 放在最前面</li>
</ul>
</li>
<li>正则表达式匹配<ul>
<li>  name:/[mb]oat/</li>
</ul>
</li>
<li>模糊匹配(fuzzy query)<ul>
<li>  name:roam~1</li>
<li>  匹配与 roam 差 1 个 character 的词, 比如 foam roams 等</li>
</ul>
</li>
<li>近似度查询(proximity search)<ul>
<li>  “for quick” ~5</li>
<li>  以 term 为单位进行差异比较, 比如 <code>quick fox</code> 和 <code>quick brown fox</code> 都会被匹配</li>
</ul>
</li>
</ul>
<h3 id="2-4-2-实验"><a href="#2-4-2-实验" class="headerlink" title="2.4.2 实验:"></a>2.4.2 实验:</h3><p>给一个新索引中插入以下记录</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST test_search_index/_bulk</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_id&quot;</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;username&quot;</span>:<span class="string">&quot;alfred way&quot;</span>,<span class="attr">&quot;job&quot;</span>:<span class="string">&quot;java engineer&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">18</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;1990-01-02&quot;</span>,<span class="attr">&quot;isMarried&quot;</span>:<span class="literal">false</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_id&quot;</span>:<span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;username&quot;</span>:<span class="string">&quot;alfred&quot;</span>,<span class="attr">&quot;job&quot;</span>:<span class="string">&quot;java senior engineer and java specialist&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">28</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;1980-05-07&quot;</span>,<span class="attr">&quot;isMarried&quot;</span>:<span class="literal">true</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_id&quot;</span>:<span class="number">3</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;username&quot;</span>:<span class="string">&quot;lee&quot;</span>,<span class="attr">&quot;job&quot;</span>:<span class="string">&quot;java and ruby engineer&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">22</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;1985-08-07&quot;</span>,<span class="attr">&quot;isMarried&quot;</span>:<span class="literal">false</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_id&quot;</span>:<span class="number">4</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;username&quot;</span>:<span class="string">&quot;alfred junior way&quot;</span>,<span class="attr">&quot;job&quot;</span>:<span class="string">&quot;ruby engineer&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">23</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;1989-08-07&quot;</span>,<span class="attr">&quot;isMarried&quot;</span>:<span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure>

<p>得到如下数据:</p>
<table>
<thead>
<tr>
<th>_id</th>
<th>username</th>
<th>job</th>
<th>age</th>
<th>birth</th>
<th>isMarried</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>alfred way</td>
<td>java engineer</td>
<td>18</td>
<td>1990-01-02</td>
<td>false</td>
</tr>
<tr>
<td>2</td>
<td>alfred</td>
<td>java senior engineer and java specialist</td>
<td>28</td>
<td>1980-05-07</td>
<td>true</td>
</tr>
<tr>
<td>3</td>
<td>lee</td>
<td>java and ruby engineer</td>
<td>22</td>
<td>1985-08-07</td>
<td>false</td>
</tr>
<tr>
<td>4</td>
<td>alfred junior way</td>
<td>ruby engineer</td>
<td>23</td>
<td>1989-08-07</td>
<td>false</td>
</tr>
</tbody></table>
<h4 id="q-alfred"><a href="#q-alfred" class="headerlink" title="q=alfred"></a>q=alfred</h4><blockquote>
<p>  查询任何字段值包含 alfred 的记录</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=alfred</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;profile&quot;</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">30</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">1.2039728</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.2039728</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java senior engineer and java specialist&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1980-05-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.33698124</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.2760198</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;profile&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;shards&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span> : <span class="string">&quot;[SzMJQTNvT2W8aR2j82AibQ][test_search_index][0]&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;searches&quot;</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;query&quot;</span> : [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;DisjunctionMaxQuery&quot;</span>,</span><br><span class="line">                &quot;description&quot; : &quot;&quot;&quot;(username.keyword:alfred | MatchNoDocsQuery(&quot;failed [isMarried] query, caused by illegal_argument_exception:[Can&#x27;t parse boolean value [alfred], expected [true] or [false]]&quot;) | MatchNoDocsQuery(&quot;failed [birth] query, caused by parse_exception:[failed to parse date field [alfred] with format [strict_date_optional_time||epoch_millis]: [failed to parse date field [alfred] with format [strict_date_optional_time||epoch_millis]]]&quot;) | job:alfred | MatchNoDocsQuery(&quot;failed [age] query, caused by number_format_exception:[For input string: &quot;alfred&quot;]&quot;) | username:alfred | job.keyword:alfred)&quot;&quot;&quot;,</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>  type: DisjunctionMaxQuery</li>
<li>description: es 实际的执行过程(或关系)<ul>
<li>  username.keyword: alfred</li>
<li>  job: alfred</li>
<li>  username: alfred</li>
<li>  job.keyword: alfred</li>
<li>  其他字段不是 string 类型, 不参与比较</li>
</ul>
</li>
</ul>
<h4 id="q-username-alfred-way"><a href="#q-username-alfred-way" class="headerlink" title="q=username:alfred way"></a>q=username:alfred way</h4><blockquote>
<p>  查询 username 列包含 alfred 或任意列包含 way 的记录</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:alfred way</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.8124252</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.43250346</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java senior engineer and java specialist&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1980-05-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="q-username-”alfred-way”"><a href="#q-username-”alfred-way”" class="headerlink" title="q=username:”alfred way”"></a>q=username:”alfred way”</h4><blockquote>
<p>  查询 username 包含 “alfred way” 的所有记录</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:&quot;alfred way&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.99185646</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.99185646</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="q-username-alfred-way-1"><a href="#q-username-alfred-way-1" class="headerlink" title="q=username:(alfred way)"></a>q=username:(alfred way)</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:(alfred way)</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.8124252</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.43250346</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java senior engineer and java specialist&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1980-05-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="q-username-alfred-AND-way"><a href="#q-username-alfred-AND-way" class="headerlink" title="q=username:alfred AND way"></a>q=username:alfred AND way</h4><blockquote>
<p>  返回 username 包含 alfred, 且任意字段包含 way 的所有文档</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:alfred AND way</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">6</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.8124252</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="q-username-alfred-AND-way-1"><a href="#q-username-alfred-AND-way-1" class="headerlink" title="q=username:(alfred AND way)"></a>q=username:(alfred AND way)</h4><blockquote>
<p>  返回 username 同时包含 alfred 和 way 的所有文档</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:(alfred AND way)</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.8124252</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="q-username-alfred-NOT-way"><a href="#q-username-alfred-NOT-way" class="headerlink" title="q=username:(alfred NOT way)"></a>q=username:(alfred NOT way)</h4><blockquote>
<p>  返回 username 包含 alfred 但不能包含 way 的所有文档</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:(alfred NOT way)</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.43250346</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.43250346</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java senior engineer and java specialist&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1980-05-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="q-username-alfred-way-2"><a href="#q-username-alfred-way-2" class="headerlink" title="q=username:(alfred +way)"></a>q=username:(alfred +way)</h4><blockquote>
<p>  返回 username 一定包含 way, 可以包含 alfred 的所有文档</p>
<p>  但在 url 中+会被解析为空格, 按照上面的内容输入的话会被识别成空格, 需要转化为 <code>%2B</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:(alfred +way)</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.8124252</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.43250346</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java senior engineer and java specialist&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1980-05-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>q=username:(alfred %2Bway)</p>
<blockquote>
<p>  这才是真正的+</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:(alfred %2Bway)</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.8124252</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="q-username-a"><a href="#q-username-a" class="headerlink" title="q=username:/[a]?.*/"></a>q=username:/[a]?.*/</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:/[a]?.*/</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">11</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java senior engineer and java specialist&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1980-05-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;lee&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java and ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">22</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1985-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-3-Request-Body-Search"><a href="#2-4-3-Request-Body-Search" class="headerlink" title="2.4.3 Request Body Search"></a>2.4.3 Request Body Search</h3><ul>
<li>将查询语句通过 http request body 发送到 es, 主要包含以下参数:  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;user&quot;</span>: <span class="string">&quot;alfred&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>  query 符合 Query DSL 语法的查询语句</li>
<li>  from, size</li>
<li>  timeout</li>
<li>  sort</li>
</ul>
</li>
</ul>
<p>QueryDSL: 基于 JSON 定义的查询语言, 主要包含如下两种类型</p>
<ul>
<li>字段类查询: 如 term, match, range 等, 只针对某个字段进行查询, 主要包含以下两类:<ul>
<li>  全文匹配: 针对 text 类型的字段进行全文检索, 会对查询语句先进行分词处理, 再拿分词结果和 es 中的倒排索引去匹配, 如 match, match_phrase 等 query 类型</li>
<li>  单词匹配: 不会对查询语句做分词处理, 直接去匹配字段的倒排索引, 如 term, terms, range 等 query 类型</li>
</ul>
</li>
<li>  复合查询: 如 bool 查询等, 包含一个或多个字段类查询或者复合类查询</li>
</ul>
<h4 id="2-4-3-1-相关性算分"><a href="#2-4-3-1-相关性算分" class="headerlink" title="2.4.3.1 相关性算分"></a>2.4.3.1 相关性算分</h4><p>相关性算分(relevance)是指文档与查询语句间的相关度:</p>
<ul>
<li>  通过倒排索引可以获取与查询语句相匹配的文档列表, 那么如何将最符合用户查询需求的文档放在前列呢</li>
<li>  本质是一个排序问题, 排序的依据是相关性算分</li>
</ul>
<p>相关性算分的几个重要概念如下:</p>
<ul>
<li>  TF(Term Frequency, 词频): 即单词再该文档中出现的次数, 词频越高, 相关度越大</li>
<li>  DF(Document Frequency, 文档频率): 即单词出现的文档数</li>
<li>  IDF(Inverse Document Frequency, 逆向文档频率): 与文档频率相反, 即单词出现的文档越少, 相关度越高</li>
<li>  Field-length Norm: 文档越短, 相关性越高</li>
</ul>
<p>ES 目前主要有两个相关性算分模型:</p>
<ul>
<li><p>TF/IDF 模型: Lucene 的经典模型, 计算公式如下:<br>  $$<br>  score(q,d)=coord(q,d)·queryNorm(q)·\sum_{t\ in\ q}(tf(t\ in\ d)·idf(t)^2·t.getBoost()·norm(t,d))<br>  $$</p>
<blockquote>
<p>  对分词后的每一个 term 计算相关性并求和, 从公式可以看到, 词频越高, 文档频率越小, 文档越短, 最终的相关性得分就会越高</p>
</blockquote>
<ul>
<li>  score: 相关性得分</li>
<li>  q: 查询语句</li>
<li>  d: 匹配的文档</li>
<li>  coord(q,d)/queryNorm(q): 正则化处理</li>
<li>  t in q: t 为查询语句分词后的单词</li>
<li>  tf: 词频计算</li>
<li>  idf: 逆向文档频率计算</li>
<li>  t.getBoost(): 是否做过特定加权</li>
<li>  norm: Field Length Norm 计算</li>
</ul>
</li>
<li><p>BM25 模型(5.x 后默认的模型)<br>  $$<br>  score(D,Q)=\sum_{i=1}IDF(qi)·\frac{f(q_i,D)·(k_1+1)}{f(q_i,D)+k_1·(1-b+b·\frac{|D|}{avgd1})}<br>  $$</p>
<blockquote>
<p>  BM25 模型中的 BM 值 BaseMatch, 25 指迭代了 25 次才计算方法, 是针对 TF/IDF 的一个优化</p>
</blockquote>
<ul>
<li>  f(qi,D)值 qi(即查询语句分词后的单词) 在文档 D 中的 TF</li>
<li>  相比 TF/IDF 的一大优化是降低了 tf 在过大时的权重</li>
</ul>
</li>
</ul>
<h4 id="2-4-3-2-MatchQuery"><a href="#2-4-3-2-MatchQuery" class="headerlink" title="2.4.3.2 MatchQuery"></a>2.4.3.2 MatchQuery</h4><p>对字段做全文检索, 是最基本和常用的查询类型, 默认情况下会将查询内容分词, 然后返回每个分词能够匹配到的文档</p>
<p>已知 username 的倒排索引为:</p>
<table>
<thead>
<tr>
<th>单词</th>
<th>文档 id 列表</th>
</tr>
</thead>
<tbody><tr>
<td>alfred</td>
<td>1,2</td>
</tr>
<tr>
<td>way</td>
<td>1</td>
</tr>
</tbody></table>
<img src="https://tva1.sinaimg.cn/large/008eGmZEly1gpc26ysl2aj30r80w6jto.jpg" style="zoom:50%;" />

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;									<span class="comment">// 关键词</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;alfred way&quot;</span>	<span class="comment">// 字段名和待查询的语句</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">6</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">3</span>,													<span class="comment">// 符合条件的文档数</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [															<span class="comment">// 返回文档列表</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.9918565</span>,								<span class="comment">// 文档相关度得分</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.8124252</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.43250346</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java senior engineer and java specialist&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1980-05-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 operator 参数可以控制单词间的匹配关系, 可选项为 or 和 and, 此时只会匹配 username 同时包含 <code>alfred</code> 和 <code>way</code> 的文档</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;username&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.9918565</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.8124252</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>  通过 <code>minimun_should_match</code> 参数可以控制需要匹配的单词数: 需要至少包含查询语句的 n 的单词</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;username&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;minimun_should_match&quot;</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-3-Match-Phrase-Query"><a href="#2-4-3-3-Match-Phrase-Query" class="headerlink" title="2.4.3.3 Match Phrase Query"></a>2.4.3.3 Match Phrase Query</h4><p>对字段检索有顺序要求:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;job&quot;</span>: <span class="string">&quot;java engineer&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">0.56026345</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.56026345</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过 slop 参数可以控制单词间的间隔</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;job&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;slop&quot;</span>: <span class="number">1</span>		<span class="comment">// 允许 java 和 engineer 之间有一个单词间隔</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-4-3-4-Query-String-Query"><a href="#2-4-3-4-Query-String-Query" class="headerlink" title="2.4.3.4 Query String Query"></a>2.4.3.4 Query String Query</h4><p>类似于 URISearch 中的 q 参数查询</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;username&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;alfred AND way&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;fields&quot;</span>: [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;job&quot;</span>], </span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;alfred OR (java AND ruby)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-5-Simple-Query-String-Query"><a href="#2-4-3-5-Simple-Query-String-Query" class="headerlink" title="2.4.3.5 Simple Query String Query"></a>2.4.3.5 Simple Query String Query</h4><ul>
<li>  类似 Query String, 但是会忽略错误的查询语法, 并且仅支持部分查询语法</li>
<li>常用的逻辑符号如下, 不能使用 AND, OR, NOT 等关键词<ul>
<li>  <code>+</code>: 代指 AND</li>
<li>  <code>|</code>: 代指 OR</li>
<li>  <code>-</code>: 代指 NOT</li>
</ul>
</li>
</ul>
<h4 id="2-4-3-6-Term-Query"><a href="#2-4-3-6-Term-Query" class="headerlink" title="2.4.3.6 Term Query"></a>2.4.3.6 Term Query</h4><p>将查询语句作为整个单词进行查询, 即不对查询语句做分词处理</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;alfred way&quot;</span>	<span class="comment">// Term 不会对分词, 直接去 es 的倒排索引中匹配, 而倒排索引此时已经完成了分词, 因此查询结果为空</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [ ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-7-RangeQuery"><a href="#2-4-3-7-RangeQuery" class="headerlink" title="2.4.3.7 RangeQuery"></a>2.4.3.7 RangeQuery</h4><p>范围查询主要针对数值和日期类型</p>
<table>
<thead>
<tr>
<th>转义符</th>
<th>翻译</th>
<th>对应功能</th>
</tr>
</thead>
<tbody><tr>
<td>gt</td>
<td>greater than</td>
<td>&gt;</td>
</tr>
<tr>
<td>gte</td>
<td>greater than or equal to</td>
<td>&gt;=</td>
</tr>
<tr>
<td>lt</td>
<td>less than</td>
<td>&lt;</td>
</tr>
<tr>
<td>lte</td>
<td>less than or equal to</td>
<td>&lt;=</td>
</tr>
</tbody></table>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">&quot;lte&quot;</span>: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对日期的查询:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;birth&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;lt&quot;</span>: <span class="string">&quot;now-35y&quot;</span>	<span class="comment">// 使用具体日期时需要用||做隔离</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp:</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java senior engineer and java specialist&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1980-05-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;lee&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java and ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">22</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1985-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-8-QueryDSL-符合查询"><a href="#2-4-3-8-QueryDSL-符合查询" class="headerlink" title="2.4.3.8 QueryDSL 符合查询"></a>2.4.3.8 QueryDSL 符合查询</h4><p>复合查询是指包含字段类查询或复合查询的类型, 主要包括以下几类:</p>
<ul>
<li><p>constant_score query: 将其内部的查询结果文档得分都设定为 1 或者 boost 值, 多用于结合 bool 查询实现自定义得分</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;alfred&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;boost&quot;</span>: <span class="number">1.2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">1.2</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.2</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">18</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1990-01-02&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.2</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;java senior engineer and java specialist&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1980-05-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;test_search_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.2</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;username&quot;</span> : <span class="string">&quot;alfred junior way&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;ruby engineer&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;age&quot;</span> : <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> : <span class="string">&quot;1989-08-07&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>  bool query: 一般由一个或多个 bool 字句构成, 主要包含如下 4 个:</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>filter</td>
<td>只过滤符合条件的文档, 不计算相关性得分, 做简单匹配查询且不考虑算分时, 推荐使用 filter 代替 query</td>
</tr>
<tr>
<td>must</td>
<td>文档必须符合 must 中的所有条件, 会影响相关性得分, 多个 must 条件筛选出的文档最终得分为多个查询的得分加和</td>
</tr>
<tr>
<td>must_not</td>
<td>文档必须不符合 must_not 中的所有条件</td>
</tr>
<tr>
<td>should</td>
<td>文档可以符合 should 中的条件, 会影响相关性得分<br />只包含 should 时, 文档必须满足一个条件(<code>minimum_should_match</code> 可以控制满足条件的个数或者百分比)<br />同时包含 must 和 should 时, 文档不必满足 should 中的条件, 但如果满足会增加相关性得分</td>
</tr>
</tbody></table>
<ul>
<li>  dis_max query</li>
<li>  funcation_score query</li>
<li>  boosting query</li>
</ul>
<p>当一个查询语句位于 Query 或者 Filter 上下文时, es 执行的结果会有不同:</p>
<ul>
<li>  使用时, 尽量将不印象算分的查询放在 filter 中, 如日期, 数字, 不分词的 string 等字段</li>
</ul>
<table>
<thead>
<tr>
<th>上下文类型</th>
<th>执行类型</th>
<th>使用方式</th>
</tr>
</thead>
<tbody><tr>
<td>Query</td>
<td>查找与查询语句最匹配的文档, 对所有文档进行相关性算分并排序</td>
<td>query<br />bool 中的 must 和 should</td>
</tr>
<tr>
<td>Filter</td>
<td>查找与查询语句相匹配的文档</td>
<td>bool 中的 filter 与 must_not<br />constant_score 中的 filter</td>
</tr>
</tbody></table>
<h4 id="2-4-3-9-Count"><a href="#2-4-3-9-Count" class="headerlink" title="2.4.3.9 Count"></a>2.4.3.9 Count</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_count</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;alfred&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;count&quot;</span> : <span class="number">3</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-10-Source-Filtering"><a href="#2-4-3-10-Source-Filtering" class="headerlink" title="2.4.3.10 Source Filtering"></a>2.4.3.10 Source Filtering</h4><p>过滤返回结果中的 <code>_source</code> 字段, 节省网络开销</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// url 参数</span></span><br><span class="line">GET test_search_index/_search?_source=username</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不返回 _source</span></span><br><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回部分字段</span></span><br><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;age&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回部分字段</span></span><br><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;includes&quot;</span>: <span class="string">&quot;*a*&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;excludes&quot;</span>: <span class="string">&quot;birth&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-5-分布式特性"><a href="#2-5-分布式特性" class="headerlink" title="2.5 分布式特性"></a>2.5 分布式特性</h2><h2 id="2-6-Search-的运行机制"><a href="#2-6-Search-的运行机制" class="headerlink" title="2.6 Search 的运行机制"></a>2.6 Search 的运行机制</h2><h2 id="2-7-聚和分析"><a href="#2-7-聚和分析" class="headerlink" title="2.7 聚和分析"></a>2.7 聚和分析</h2><h2 id="2-8-数据建模"><a href="#2-8-数据建模" class="headerlink" title="2.8 数据建模"></a>2.8 数据建模</h2><h2 id="2-9-集群调优"><a href="#2-9-集群调优" class="headerlink" title="2.9 集群调优"></a>2.9 集群调优</h2><h1 id="3-Logstash"><a href="#3-Logstash" class="headerlink" title="3. Logstash"></a>3. Logstash</h1><h2 id="3-1-入门"><a href="#3-1-入门" class="headerlink" title="3.1 入门"></a>3.1 入门</h2><h2 id="3-2-插件讲解"><a href="#3-2-插件讲解" class="headerlink" title="3.2 插件讲解"></a>3.2 插件讲解</h2><h2 id="3-3-实例分析"><a href="#3-3-实例分析" class="headerlink" title="3.3 实例分析"></a>3.3 实例分析</h2><h1 id="4-Beats"><a href="#4-Beats" class="headerlink" title="4. Beats"></a>4. Beats</h1><h2 id="4-1-Filebeat"><a href="#4-1-Filebeat" class="headerlink" title="4.1 Filebeat"></a>4.1 Filebeat</h2><h2 id="4-2-Metricbeat"><a href="#4-2-Metricbeat" class="headerlink" title="4.2 Metricbeat"></a>4.2 Metricbeat</h2><h2 id="4-3-Packetbeat"><a href="#4-3-Packetbeat" class="headerlink" title="4.3 Packetbeat"></a>4.3 Packetbeat</h2><h2 id="4-4-其他-beat"><a href="#4-4-其他-beat" class="headerlink" title="4.4 其他 beat"></a>4.4 其他 beat</h2><h1 id="5-Kibana"><a href="#5-Kibana" class="headerlink" title="5 Kibana"></a>5 Kibana</h1><h2 id="5-1-入门与管理"><a href="#5-1-入门与管理" class="headerlink" title="5.1 入门与管理"></a>5.1 入门与管理</h2><h2 id="5-2-数据探索-Discovery"><a href="#5-2-数据探索-Discovery" class="headerlink" title="5.2 数据探索 Discovery"></a>5.2 数据探索 Discovery</h2><h2 id="5-3-可视化分析"><a href="#5-3-可视化分析" class="headerlink" title="5.3 可视化分析"></a>5.3 可视化分析</h2><h1 id="6-搜索项目"><a href="#6-搜索项目" class="headerlink" title="6 搜索项目"></a>6 搜索项目</h1><h2 id="6-1-快速搭建搜索系统"><a href="#6-1-快速搭建搜索系统" class="headerlink" title="6.1 快速搭建搜索系统"></a>6.1 快速搭建搜索系统</h2><h2 id="6-2-日志分析"><a href="#6-2-日志分析" class="headerlink" title="6.2 日志分析"></a>6.2 日志分析</h2><h2 id="6-3-数据分析"><a href="#6-3-数据分析" class="headerlink" title="6.3 数据分析"></a>6.3 数据分析</h2>
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2020/12/20/Docker-%E5%AE%9E%E7%8E%B0-DevOps/" rel="next" title="Docker 实现 DevOps">
                <i class="fa fa-chevron-left"></i> Docker 实现 DevOps
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/blog/archives">
                
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/blog/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-Elastic-Stack"><span class="nav-text">1 Elastic Stack</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="nav-text">1. 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%AE%89%E8%A3%85"><span class="nav-text">1.2 安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-Elasticsearch"><span class="nav-text">1.2.1 Elasticsearch</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#docker"><span class="nav-text">docker</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-LogStash"><span class="nav-text">1.2.2 LogStash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-Beats"><span class="nav-text">1.2.3 Beats</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-4-Kinbana"><span class="nav-text">1.2.4 Kinbana</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Elasticsearch"><span class="nav-text">2. Elasticsearch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E6%A6%82%E8%BF%B0"><span class="nav-text">2.1 概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-%E5%B8%B8%E8%A7%81%E6%9C%AF%E8%AF%AD"><span class="nav-text">2.1.1 常见术语</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Document"><span class="nav-text">Document</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Index"><span class="nav-text">Index</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-RESTAPI"><span class="nav-text">2.1.2 RESTAPI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-%E7%B4%A2%E5%BC%95-API"><span class="nav-text">2.1.3 索引 API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-4-%E6%96%87%E6%A1%A3-API"><span class="nav-text">2.1.4 文档 API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3"><span class="nav-text">创建文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3"><span class="nav-text">批量创建文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="nav-text">查询文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="nav-text">批量查询文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="nav-text">更新文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="nav-text">删除文档</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E4%B8%8E%E5%88%86%E8%AF%8D"><span class="nav-text">2.2 倒排索引与分词</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-%E7%AE%80%E4%BB%8B"><span class="nav-text">2.2.1 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-text">2.2.2 倒排索引的组成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-%E5%88%86%E8%AF%8D"><span class="nav-text">2.2.3 分词</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Analyze-API"><span class="nav-text">Analyze API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A2%84%E5%AE%9A%E4%B9%89%E7%9A%84%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-text">预定义的分词器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D"><span class="nav-text">中文分词</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D"><span class="nav-text">自定义分词</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-Mapping"><span class="nav-text">2.3 Mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-%E7%AE%80%E4%BB%8B"><span class="nav-text">2.3.1 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-%E8%87%AA%E5%AE%9A%E4%B9%89-mapping"><span class="nav-text">2.3.2 自定义 mapping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-text">2.3.3 核心数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-4-Dynamic-Mapping"><span class="nav-text">2.3.4 Dynamic Mapping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-5-%E6%97%A5%E6%9C%9F%E4%B8%8E%E6%95%B0%E5%AD%97%E7%9A%84%E8%AF%86%E5%88%AB"><span class="nav-text">2.3.5 日期与数字的识别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-6-DynamicTemplates"><span class="nav-text">2.3.6 DynamicTemplates</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-7-%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="nav-text">2.3.7 索引模板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-Search-API"><span class="nav-text">2.4 Search API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-URI-Search"><span class="nav-text">2.4.1 URI Search</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E5%AE%9E%E9%AA%8C"><span class="nav-text">2.4.2 实验:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#q-alfred"><span class="nav-text">q&#x3D;alfred</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#q-username-alfred-way"><span class="nav-text">q&#x3D;username:alfred way</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#q-username-%E2%80%9Dalfred-way%E2%80%9D"><span class="nav-text">q&#x3D;username:”alfred way”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#q-username-alfred-way-1"><span class="nav-text">q&#x3D;username:(alfred way)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#q-username-alfred-AND-way"><span class="nav-text">q&#x3D;username:alfred AND way</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#q-username-alfred-AND-way-1"><span class="nav-text">q&#x3D;username:(alfred AND way)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#q-username-alfred-NOT-way"><span class="nav-text">q&#x3D;username:(alfred NOT way)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#q-username-alfred-way-2"><span class="nav-text">q&#x3D;username:(alfred +way)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#q-username-a"><span class="nav-text">q&#x3D;username:&#x2F;[a]?.*&#x2F;</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-3-Request-Body-Search"><span class="nav-text">2.4.3 Request Body Search</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-1-%E7%9B%B8%E5%85%B3%E6%80%A7%E7%AE%97%E5%88%86"><span class="nav-text">2.4.3.1 相关性算分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-2-MatchQuery"><span class="nav-text">2.4.3.2 MatchQuery</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-3-Match-Phrase-Query"><span class="nav-text">2.4.3.3 Match Phrase Query</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-4-Query-String-Query"><span class="nav-text">2.4.3.4 Query String Query</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-5-Simple-Query-String-Query"><span class="nav-text">2.4.3.5 Simple Query String Query</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-6-Term-Query"><span class="nav-text">2.4.3.6 Term Query</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-7-RangeQuery"><span class="nav-text">2.4.3.7 RangeQuery</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-8-QueryDSL-%E7%AC%A6%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-text">2.4.3.8 QueryDSL 符合查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-9-Count"><span class="nav-text">2.4.3.9 Count</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-10-Source-Filtering"><span class="nav-text">2.4.3.10 Source Filtering</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E5%88%86%E5%B8%83%E5%BC%8F%E7%89%B9%E6%80%A7"><span class="nav-text">2.5 分布式特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-Search-%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="nav-text">2.6 Search 的运行机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7-%E8%81%9A%E5%92%8C%E5%88%86%E6%9E%90"><span class="nav-text">2.7 聚和分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-8-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1"><span class="nav-text">2.8 数据建模</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-9-%E9%9B%86%E7%BE%A4%E8%B0%83%E4%BC%98"><span class="nav-text">2.9 集群调优</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Logstash"><span class="nav-text">3. Logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%85%A5%E9%97%A8"><span class="nav-text">3.1 入门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%8F%92%E4%BB%B6%E8%AE%B2%E8%A7%A3"><span class="nav-text">3.2 插件讲解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-text">3.3 实例分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-Beats"><span class="nav-text">4. Beats</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Filebeat"><span class="nav-text">4.1 Filebeat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Metricbeat"><span class="nav-text">4.2 Metricbeat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-Packetbeat"><span class="nav-text">4.3 Packetbeat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E5%85%B6%E4%BB%96-beat"><span class="nav-text">4.4 其他 beat</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-Kibana"><span class="nav-text">5 Kibana</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E5%85%A5%E9%97%A8%E4%B8%8E%E7%AE%A1%E7%90%86"><span class="nav-text">5.1 入门与管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E6%95%B0%E6%8D%AE%E6%8E%A2%E7%B4%A2-Discovery"><span class="nav-text">5.2 数据探索 Discovery</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E6%9E%90"><span class="nav-text">5.3 可视化分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E6%90%9C%E7%B4%A2%E9%A1%B9%E7%9B%AE"><span class="nav-text">6 搜索项目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E6%90%9C%E7%B4%A2%E7%B3%BB%E7%BB%9F"><span class="nav-text">6.1 快速搭建搜索系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-text">6.2 日志分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="nav-text">6.3 数据分析</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">destiny</span>

  

  
</div>




  <div class="powered-by">
  <i class="fa fa-user-md"></i>
  <span id="busuanzi_container_site_uv">本站访客数:<span id="busuanzi_value_site_uv"></span></span>
  
  <!-- 由 <a class="theme-link" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> 强力驱动 -->
  </div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Code Alone </div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=6.1.0"></script>



  
  


  <script type="text/javascript" src="/blog/js/src/affix.js?v=6.1.0"></script>

  <script type="text/javascript" src="/blog/js/src/schemes/pisces.js?v=6.1.0"></script>



  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=6.1.0"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=6.1.0"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=6.1.0"></script>



  



	





  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

</body>
</html>

<script type="text/javascript" src="/js/src/love.js"></script>>